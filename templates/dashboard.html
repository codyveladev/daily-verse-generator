<!-- templates/dashboard.html -->
{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">Hello, {{ current_user.full_name or current_user.username }}!</h1>

<div class="row">
    <div class="col-lg-8">
        {% if current_mood %}
        <div class="card mb-4 shadow">
            <div class="card-body">
                <h4>Your Current Struggle</h4>
                <p class="lead">{{ current_mood.capitalize() }}
                    <a href="{{ url_for('user.set_mood') }}" class="ms-3 btn btn-sm btn-outline-primary">Change</a>
                </p>
            </div>
        </div>

        <!-- Current Daily Quote -->
        {% if today_quote %}
        <div class="card shadow mb-5">
            <div class="card-body">
                <h4>Today's Verse</h4>

                <blockquote class="blockquote quote-block mb-0">
                    <p class="fs-4">"{{ today_quote.text }}"</p>
                    <footer class="blockquote-footer text-end mt-3 fs-5">
                        {{ today_quote.reference }}
                    </footer>
                </blockquote>
                <small class="text-muted d-block mt-3">For when you're feeling {{ today_quote.topic.capitalize()
                    }}</small>
                <div class="d-grid">
                    <a href="{{ url_for('user.soap_journal', quote_id=today_quote.id) }}"
                        class="btn btn-outline-primary btn-sm mt-3">
                        üìñ Open SOAP Journal
                </a>
                </div>

            </div>
        </div>
        {% else %}
        <div class="alert alert-info mb-5">
            <strong>Your verse is being prepared...</strong> It will appear here shortly after setting your mood.
        </div>
        {% endif %}

        <!-- Previous Quotes History -->
        <h3 class="mb-4">Your Previous Verses</h3>

        {% set all_quotes = current_user.quotes | list %}
        {% set today_date = today_quote.date if today_quote else none %}

        {% if all_quotes %}
        {% set previous_quotes = all_quotes | rejectattr('date', 'equalto', today_date) | list | reverse | list %}

        {% if previous_quotes %}
        <div class="row g-4">
            {% for quote in previous_quotes[:10] %}
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-body d-flex flex-column">
                        <small class="text-muted mb-2">
                            {{ quote.date.strftime('%B %d, %Y') }} ‚Ä¢ {{ quote.topic.capitalize() }}
                        </small>
                        <blockquote class="blockquote mb-3 flex-grow-1">
                            <p class="mb-0">{{ quote.text }}</p>
                        </blockquote>
                        <footer class="blockquote-footer text-end mt-auto">
                            {{ quote.reference }}
                        </footer>
                        <a href="{{ url_for('user.soap_journal', quote_id=today_quote.id) }}"
                            class="btn btn-outline-primary btn-sm mt-3">
                            üìñ Open SOAP Journal
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if previous_quotes | length > 10 %}
        <div class="text-center mt-4">
            <p class="text-muted">Showing the last 10 verses. Your full history is growing!</p>
        </div>
        {% endif %}
        {% else %}
        <div class="card border-dashed">
            <div class="card-body text-center py-5">
                <p class="text-muted">No previous verses yet. Come back tomorrow to see your history grow.</p>
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="card border-dashed">
            <div class="card-body text-center py-5">
                <p class="text-muted">No verses yet. Set your mood to get started!</p>
            </div>
        </div>
        {% endif %}

        {% else %}
        <!-- No mood set yet -->
        <div class="card shadow">
            <div class="card-body text-center py-5">
                <h3>Ready for your daily encouragement?</h3>
                <p class="lead">Tell us what you're going through today to receive a personalized Bible verse.</p>
                <a href="{{ url_for('user.set_mood') }}" class="btn btn-lg btn-primary">Set My Mood</a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4 mt-4 mt-lg-0">
        <div class="card shadow">
            <div class="card-body">
                <h5>Quick Links</h5>
                <ul class="list-unstyled">
                    <li class="mb-2"><a href="{{ url_for('user.set_mood') }}" class="text-decoration-none">‚ú® Set or
                            Change Mood</a></li>
                    <li class="mb-2"><a href="{{ url_for('user.profile') }}" class="text-decoration-none">‚öôÔ∏è Edit
                            Profile</a></li>
                    <li><a href="{{ url_for('auth.logout') }}" class="text-decoration-none">üö™ Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}